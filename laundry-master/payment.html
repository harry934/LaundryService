<!doctype html>
<html class="no-js" lang="zxx">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Payment | Laundry Service</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/fontawesome-all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --primary: #10b981; /* Trust Green for Payment */
            --primary-dark: #059669;
            --surface: #ffffff;
            --background: #f1f5f9;
            --text-heading: #0f172a;
            --text-body: #475569;
            --border: #e2e8f0;
            --focus-ring: rgba(16, 185, 129, 0.2);
        }

        body {
            background-color: var(--background);
            font-family: 'Inter', sans-serif;
            color: var(--text-body);
            -webkit-font-smoothing: antialiased;
            margin: 0;
            line-height: 1.5;
        }

        .payment-wrapper {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .payment-card {
            background: var(--surface);
            width: 100%;
            max-width: 440px;
            border-radius: 24px;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.08);
            overflow: hidden;
            border: 1px solid #fff;
        }

        .header-section {
            background: linear-gradient(to bottom, #f8fafc, #fff);
            padding: 32px 32px 24px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .brand-logo {
            height: 48px;
            width: auto;
            margin-bottom: 16px;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.05));
        }

        .header-section h1 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-heading);
            margin: 0 0 4px 0;
            letter-spacing: -0.025em;
        }

        .order-pill {
            display: inline-flex;
            align-items: center;
            background: #f1f5f9;
            padding: 4px 12px;
            border-radius: 99px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-body);
            margin-top: 8px;
        }

        .content-section {
            padding: 32px;
        }

        /* Payment Method Selection */
        .payment-selector {
            display: grid;
            gap: 12px;
            margin-bottom: 24px;
        }

        .payment-radio {
            display: none;
        }

        .payment-option-card {
            display: flex;
            align-items: center;
            padding: 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .payment-option-card:hover { border-color: #cbd5e1; }

        .payment-radio:checked + .payment-option-card {
            border-color: var(--primary);
            background: #ecfdf5;
        }

        .radio-circle {
            width: 20px;
            height: 20px;
            border: 2px solid #cbd5e1;
            border-radius: 50%;
            margin-right: 12px;
            position: relative;
        }

        .payment-radio:checked + .payment-option-card .radio-circle {
            border-color: var(--primary);
            background: var(--primary);
            box-shadow: inset 0 0 0 4px #ecfdf5;
        }

        .option-info { flex: 1; }
        .option-title { font-weight: 600; color: var(--text-heading); font-size: 14px; }
        .option-desc { font-size: 12px; color: var(--text-body); }

        /* Method Views */
        .method-view { display: none; animation: fadeIn 0.3s ease; }
        .method-view.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* Till Card Design */
        .till-display-card {
            background: #064e3b;
            border-radius: 16px;
            padding: 20px;
            color: #fff;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
        }
        
        .till-display-card::after {
            content: '';
            position: absolute;
            top: 0; right: 0; bottom: 0; left: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, transparent 100%);
        }

        .lbl { font-size: 11px; text-transform: uppercase; letter-spacing: 1px; opacity: 0.8; }
        .val { font-size: 24px; font-weight: 700; font-family: 'Monaco', monospace; letter-spacing: 1px; margin-top: 4px; }

        /* Interactions */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; font-size: 13px; font-weight: 600; color: var(--text-heading); margin-bottom: 8px; }
        
        .clean-input {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--border);
            border-radius: 10px;
            font-size: 16px;
            font-family: inherit;
            transition: all 0.2s;
            outline: none;
        }
        
        .clean-input:focus { border-color: var(--primary); box-shadow: 0 0 0 4px var(--focus-ring); }

        .btn-action {
            width: 100%;
            padding: 14px;
            background: var(--text-heading);
            color: #fff;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-action:hover { background: #000; transform: translateY(-1px); }
        .btn-action.btn-green { background: var(--primary); }
        .btn-action.btn-green:hover { background: var(--primary-dark); }
        
        /* Loader */
        .loader-spinner {
            width: 20px; height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="payment-wrapper">
        <div class="payment-card">
            <!-- HEADER -->
            <div class="header-section">
                <!-- Logo Removed Request -->
                <h1>Complete Payment</h1>
                <div class="order-pill">
                    <span style="opacity:0.6; margin-right:6px">ORDER</span>
                    <span id="display-order-id-header">#...</span>
                </div>
            </div>

            <!-- CONTENT -->
            <div class="content-section" id="state-payment-details">
                <!-- Method Selector -->
                <div class="payment-selector">
                    <label>
                        <input type="radio" name="pay_method" value="till" class="payment-radio" onchange="toggleMethod('till')">
                        <div class="payment-option-card">
                            <div class="radio-circle"></div>
                            <div class="option-info">
                                <div class="option-title">Buy Goods Till</div>
                                <div class="option-desc">Manual entry via M-Pesa menu</div>
                            </div>
                            <i class="fas fa-store" style="color:#94a3b8"></i>
                        </div>
                    </label>

                    <label>
                        <input type="radio" name="pay_method" value="stk" class="payment-radio" onchange="toggleMethod('stk')">
                        <div class="payment-option-card">
                            <div class="radio-circle"></div>
                            <div class="option-info">
                                <div class="option-title">M-Pesa Express</div>
                                <div class="option-desc">Automatic STK push to phone</div>
                            </div>
                            <i class="fas fa-mobile-alt" style="color:#94a3b8"></i>
                        </div>
                    </label>
                </div>

                <!-- View: Till -->
                <div id="view-till" class="method-view">
                    <div class="till-display-card">
                        <div class="lbl">TILL NUMBER</div>
                        <div class="val">5780924</div>
                        <div style="border-top:1px solid rgba(255,255,255,0.2); margin-top:16px; padding-top:12px; font-size:12px; display:flex; justify-content:space-between;">
                            <span>Laundry Service</span>
                            <span>Valid</span>
                        </div>
                    </div>
                    <button class="btn-action" id="btn-manual-paid">
                        <span>I Have Paid</span>
                    </button>
                    <p style="text-align:center; font-size:12px; color:#64748b; margin-top:16px;">
                        Go to M-Pesa &rarr; Buy Goods &rarr; Enter Till
                    </p>
                </div>

                <!-- View: STK -->
                <div id="view-stk" class="method-view">
                    <div class="form-group">
                        <label class="form-label">M-Pesa Phone Number</label>
                        <input type="tel" id="stk-phone" class="clean-input" placeholder="07XX XXX XXX" maxlength="10">
                    </div>

                    <button class="btn-action btn-green" id="btn-send-stk">
                        <i class="fas fa-paper-plane"></i>
                        <span>Send Request</span>
                    </button>

                    <!-- Hidden Confirm -->
                    <div id="stk-confirm-area" style="display:none; margin-top:20px;">
                        <div style="background:#f0fdf4; border:1px solid #bbf7d0; padding:12px; border-radius:8px; font-size:13px; color:#166534; margin-bottom:12px; display:flex; align-items:center; gap:8px;">
                            <div class="loader-spinner" style="border-color:rgba(22,101,52,0.2); border-top-color:#166534; width:16px; height:16px;"></div>
                            Check your phone for the PIN prompt.
                        </div>
                        <button class="btn-action" id="btn-stk-paid">
                            <span>I Have Paid</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- VIEW: VERIFYING -->
            <div id="state-pending" style="display:none; text-align:center; padding:60px 40px;">
                <div style="width:72px; height:72px; background:#f0fdf4; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 24px;">
                    <i class="fas fa-check" style="font-size:32px; color:#166534;"></i>
                </div>
                <h2 style="font-size:20px; font-weight:700; color:var(--text-heading); margin-bottom:8px;">Payment Received</h2>
                <p style="color:var(--text-body); font-size:14px; margin-bottom:32px;">We are verifying with the network. You can track your order status live.</p>
                
                <a href="track.html" class="btn-action">Track Order</a>
                <p style="font-size:12px; color:#94a3b8; margin-top:24px;">Support: (01) 126 013 34</p>
            </div>
        </div>
    </div>

    <script src="assets/js/jquery-1.12.4.min.js"></script>
    <script src="assets/js/session.js"></script>
    <script>
        $(document).ready(function() {
            const orderId = localStorage.getItem('lastLaundryOrderId');
            if (orderId) {
                $('#display-order-id-header').text(orderId);
            }

            // INITIAL STATE: Everything Hidden
            // We rely on user click to reveal options

            // RECOVER STATE
            const isPending = localStorage.getItem('payment_pending_' + orderId);
            if (isPending === 'true') {
                showState('state-pending');
                startPolling(orderId);
            } else {
                showState('state-payment-details');
            }

            function showState(stateId) {
                $('#state-payment-details, #state-pending').hide();
                $('#' + stateId).fadeIn();
            }

            // METHOD SWITCHING
            window.toggleMethod = function(method) {
                $('.method-view').hide().removeClass('active'); // Hide all first
                $('#view-' + method).fadeIn().addClass('active'); // Reveal specific
            };

            // POLLING FOR CONFIRMATION
            function startPolling(id) {
                const interval = setInterval(() => {
                    const API_BASE = "http://127.0.0.1:3000/api";
                    // Using admin/orders to check status in list (simpler for this lightweight app)
                    // Or specific endpoint if we updated server.js
                    fetch(`${API_BASE}/admin/orders`)
                        .then(r => r.json())
                        .then(orders => {
                            const order = orders.find(o => o.orderId === id);
                            if (order && (order.status === 'Processing' || order.status === 'Confirmed')) {
                                clearInterval(interval);
                                alert('Payment Confirmed! Redirecting to tracker...');
                                window.location.replace('track.html');
                            }
                        })
                        .catch(e => console.log('Polling...', e));
                }, 3000); // Check every 3 seconds
            }

            // SHARED UPDATE FUNCTION (Set to Pending)
            function markOrderPaid() {
                 if (!orderId) return;
                 const API_BASE = "http://127.0.0.1:3000/api";
                 
                 // Get phone if available
                 let rawPhone = $('#stk-phone').val().trim();
                 // Clean it
                 rawPhone = rawPhone.replace(/\D/g,''); 
                 // Validations are done before calling this usually, but good to have
                 
                 const body = { status: 'Payment Pending' };
                 if (rawPhone.length >= 9) body.phone = '+254' + (rawPhone.length > 9 ? rawPhone.slice(-9) : rawPhone);

                 fetch(`${API_BASE}/orders/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                }).then(res => {
                    localStorage.setItem('payment_pending_' + orderId, 'true');
                    showState('state-pending');
                    startPolling(orderId);
                }).catch(e => {
                    alert('Saved locally. Please wait for confirmation.');
                    localStorage.setItem('payment_pending_' + orderId, 'true');
                    showState('state-pending');
                    startPolling(orderId);
                });
            }

            // TILL: I Have Paid
            $('#btn-manual-paid').click(function() {
                markOrderPaid();
            });

            // STK: Send Push
            $('#btn-send-stk').click(function() {
                 let rawPhone = $('#stk-phone').val().trim();
                 rawPhone = rawPhone.replace(/\D/g,'');
                 
                 // Exact 10 digit validation as requested "must accept exactly 10 digits"
                 // e.g. 0712345678
                 if (rawPhone.length !== 10) {
                     alert('Please enter a valid 10-digit phone number (e.g., 0712345678).');
                     return;
                 }
                 
                 // Simulate Push
                 $('#btn-send-stk').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Sending...');
                 setTimeout(() => {
                     $('#btn-send-stk').hide();
                     $('#stk-confirm-area').fadeIn();
                 }, 1500);
            });

            // STK: I Have Paid (After Push)
            $('#btn-stk-paid').click(function() {
                markOrderPaid();
            });
        });
    </script>
</body>
</html>
