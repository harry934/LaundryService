<!doctype html>
<html class="no-js" lang="zxx">
<head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <title>Payment | Laundry Service</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">
    <link rel="stylesheet" href="assets/css/fontawesome-all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        :root {
            --primary: #E63946;
            --secondary: #1a202c;
            --mpesa-green: #49c561;
            --neutral-bg: #f7fafc;
            --border: #e2e8f0;
        }
        body {
            background-color: var(--neutral-bg);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: #2d3748;
        }
        .payment-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px 15px;
        }
        .payment-card {
            background: #ffffff;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            max-width: 520px;
            width: 100%;
            border: 1px solid var(--border);
            overflow: hidden;
        }
        .payment-header {
            padding: 30px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }
        .payment-header i {
            font-size: 48px;
            color: var(--mpesa-green);
            margin-bottom: 20px;
        }
        .payment-header h2 {
            font-size: 24px;
            font-weight: 800;
            color: var(--secondary);
            margin: 0;
        }
        .payment-body {
            padding: 40px 30px;
        }
        .status-badge {
            display: inline-block;
            padding: 6px 16px;
            border-radius: 50px;
            font-size: 13px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 25px;
        }
        .status-pending { background: #fffaf0; color: #b7791f; border: 1px solid #fbd38d; }
        .status-booked { background: #f0fff4; color: #276749; border: 1px solid #c6f6d5; }

        .btn-refined {
            border-radius: 8px;
            padding: 14px 24px;
            font-weight: 700;
            font-size: 15px;
            width: 100%;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            border: none;
        }
        .btn-primary-action {
            background: var(--primary);
            color: #fff;
        }
        .btn-primary-action:hover {
            background: #d62828;
            transform: translateY(-1px);
        }
        .btn-secondary-action {
            background: #fff;
            color: #4a5568;
            border: 1px solid var(--border);
            margin-top: 12px;
        }
        .btn-secondary-action:hover {
            background: #edf2f7;
            color: #2d3748;
        }

        /* Payment Reveal Styling */
        .payment-detail-reveal {
            display: none;
            background: #fdfdfd;
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
        }
        .till-box {
            background: var(--neutral-bg);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 25px;
        }
        .till-label { font-size: 12px; font-weight: 700; color: #718096; text-transform: uppercase; }
        .till-number { font-size: 36px; font-weight: 900; color: var(--secondary); letter-spacing: 2px; }

        /* Pending State Styles */
        #state-pending { display: none; text-align: center; }
        .contact-card {
            background: var(--neutral-bg);
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
        }
        .contact-phone { font-size: 20px; font-weight: 800; color: var(--primary); margin: 10px 0; }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="payment-card">
            <!-- Stage 1: Confirmation -->
            <div id="state-confirmation" style="display: none;">
                <div class="payment-header">
                    <i class="fas fa-check-circle"></i>
                    <h2>Thank you for booking with us!</h2>
                </div>
                <div class="payment-body text-center">
                    <div class="status-badge status-booked">Booking Confirmed</div>
                    <p class="mb-30">Your order <strong><span id="display-order-id">T-XXXXX</span></strong> has been received. Please complete the payment to proceed.</p>
                    
                    <button class="btn-refined btn-primary-action" id="trigger-payment">
                        <i class="fas fa-wallet"></i> I Have Paid
                    </button>
                    <a href="index.html" class="btn-refined btn-secondary-action">
                        <i class="fas fa-redo"></i> Book Another Service
                    </a>
                </div>
            </div>

                <div class="payment-header">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/1/15/M-PESA_LOGO-01.svg/512px-M-PESA_LOGO-01.svg.png" alt="M-Pesa" class="brand-logo">
                    <h2>Complete Payment</h2>
                    <p>Order <span style="font-weight:600; color:var(--text-main)" id="display-order-id-header">#...</span></p>
                </div>
                
                <div class="payment-body">
                    <!-- Method Toggle -->
                    <div class="method-tabs">
                        <button class="tab-btn active" id="tab-till">Paybill/Till</button>
                        <button class="tab-btn" id="tab-stk">STK Push</button>
                    </div>

                    <!-- TILL OPTION -->
                    <div id="view-till">
                        <div class="digital-wallet-card">
                            <div class="wallet-label">BUY GOODS TILL NUMBER</div>
                            <div class="wallet-number">5780924</div>
                            <div class="wallet-footer">
                                <span>Laundry Service Inc</span>
                                <i class="fas fa-check-circle" style="opacity:0.8"></i>
                            </div>
                        </div>
                        
                        <button class="btn-pay" id="btn-manual-paid">
                            <span>I Have Paid</span>
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        <p class="helper-text">Go to M-Pesa Menu &rarr; Lipa na M-Pesa &rarr; Buy Goods <br> Enter Till <strong>5780924</strong></p>
                    </div>

                    <!-- STK OPTION -->
                    <div id="view-stk" style="display:none;">
                        <div class="form-group">
                            <label>M-Pesa Phone Number</label>
                            <div class="input-group-refined">
                                <div class="prefix">+254</div>
                                <input type="tel" id="stk-phone" class="form-control-clean" placeholder="712 345 678" maxlength="9">
                            </div>
                        </div>

                        <div style="margin-top:24px;">
                            <button class="btn-pay btn-stk" id="btn-send-stk">
                                <i class="fas fa-mobile-alt"></i>
                                <span>Send Request</span>
                            </button>
                        </div>
                        
                        <!-- Confirmed -->
                        <div id="stk-confirm-area" style="display:none; margin-top:20px;">
                            <div style="background:#f0fdf4; color:#166534; padding:12px; border-radius:10px; font-size:13px; margin-bottom:15px; display:flex; gap:10px; align-items:center;">
                                <i class="fas fa-spinner fa-spin"></i>
                                <span>Check your phone for the PIN prompt.</span>
                            </div>
                            <button class="btn-pay" id="btn-stk-paid">
                                <span>I Have Paid</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stage 3: Verification (New Design) -->
            <div id="state-pending" style="display:none; text-align:center; padding:40px 20px;">
                <div style="width:80px; height:80px; background:#fff7ed; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
                    <i class="fas fa-hourglass-half" style="font-size:32px; color:#ea580c;"></i>
                </div>
                <h2 style="font-size:22px; font-weight:700; margin-bottom:10px;">Verifying Payment</h2>
                <p style="color:var(--text-sub); font-size:14px; margin-bottom:30px; line-height:1.6;">Thanks for paying! Our admin is confirming the transaction.<br>This usually takes 2-5 minutes.</p>
                
                <div style="background:#f8fafc; padding:20px; border-radius:16px; margin-bottom:30px;">
                    <div style="font-size:12px; text-transform:uppercase; color:var(--text-sub); font-weight:600; margin-bottom:5px;">Check Status</div>
                    <a href="track.html" style="font-weight:700; color:var(--primary); text-decoration:none;">Go to Order Tracking &rarr;</a>
                </div>

                <div style="font-size:13px; color:var(--text-sub);">
                    Taking too long? <a href="#" style="color:var(--text-main); font-weight:600;">(01) 126 013 34</a>
                </div>
            </div>
        </div>
    </div>

    <script src="assets/js/jquery-1.12.4.min.js"></script>
    <script>
        $(document).ready(function() {
            const orderId = localStorage.getItem('lastLaundryOrderId');
            if (orderId) {
                $('#display-order-id-header').text(orderId);
            }

            // check if already pending
            const isPending = localStorage.getItem('payment_pending_' + orderId);
            if (isPending === 'true') {
                showState('state-pending');
            } else {
                showState('state-payment-details');
            }

            function showState(stateId) {
                $('#state-payment-details, #state-pending').hide();
                $('#' + stateId).fadeIn();
            }

            // TABS LOGIC
            $('#tab-till').click(function() { toggleTab('till'); });
            $('#tab-stk').click(function() { toggleTab('stk'); });

            function toggleTab(mode) {
                $('.tab-btn').removeClass('active');
                if (mode === 'till') {
                    $('#view-till').show(); $('#view-stk').hide();
                    $('#tab-till').addClass('active');
                } else {
                    $('#view-stk').show(); $('#view-till').hide();
                    $('#tab-stk').addClass('active');
                }
            }

            // SHARED UPDATE FUNCTION
            function markOrderPaid() {
                 if (!orderId) return;
                 const API_BASE = "http://127.0.0.1:3000/api";
                 
                 // Get phone if available
                 const rawPhone = $('#stk-phone').val().trim();
                 const body = { status: 'Payment Pending' };
                 if (rawPhone.length === 9) body.phone = '+254' + rawPhone;

                 fetch(`${API_BASE}/orders/${orderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                }).then(res => {
                    localStorage.setItem('payment_pending_' + orderId, 'true');
                    showState('state-pending');
                }).catch(e => {
                    alert('Saved locally. Please wait for confirmation.');
                    localStorage.setItem('payment_pending_' + orderId, 'true');
                    showState('state-pending');
                });
            }

            // TILL: I Have Paid
            $('#btn-manual-paid').click(function() {
                markOrderPaid();
            });

            // STK: Send Push
            $('#btn-send-stk').click(function() {
                 const rawPhone = $('#stk-phone').val().trim();
                 if (rawPhone.length !== 9) {
                     alert('Enter valid 9-digit phone (e.g. 712345678)');
                     return;
                 }
                 // Simulate Push
                 alert(`STK Push sent to +254${rawPhone}. Enter PIN on your phone.`);
                 $('#btn-send-stk').hide();
                 $('#stk-confirm-area').fadeIn();
            });

            // STK: I Have Paid (After Push)
            $('#btn-stk-paid').click(function() {
                markOrderPaid();
            });
        });
    </script>
</body>
</html>
